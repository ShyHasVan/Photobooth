<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Photo Booth</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Pacifico&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .pacifico-font {
            font-family: 'Pacifico', cursive;
        }
        @keyframes flash {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }
        .flash-animation {
            animation: flash 0.5s ease-in-out;
        }
    </style>
</head>
<body class="bg-red-900 text-white flex items-center justify-center min-h-screen p-4">
    <div id="app-container" class="w-full max-w-4xl mx-auto">
        <!-- Welcome Screen -->
        <div id="welcome-screen" class="text-center p-8 bg-red-800 rounded-2xl shadow-lg">
            <h1 class="text-4xl md:text-6xl font-bold mb-2">Xin ch√†o & Welcome Freshers!</h1>
            <p class="pacifico-font text-yellow-400 text-3xl md:text-4xl mb-8">York Vietnamese Society</p>
            <p class="text-lg text-gray-200 mb-8">Ready to capture some memories? Step into our virtual photo booth!</p>
            <button id="start-btn" class="bg-yellow-500 hover:bg-yellow-600 text-red-900 font-bold py-4 px-8 rounded-full text-xl transition-transform transform hover:scale-105 shadow-lg">
                Start Photo Booth
            </button>
            <p id="camera-error" class="text-yellow-300 mt-4 hidden">Could not access the camera. Please check permissions and try again.</p>
        </div>

        <!-- Photo Taking Screen -->
        <div id="photo-screen" class="hidden text-center">
            <div class="relative w-full max-w-lg mx-auto aspect-[4/3] bg-black rounded-2xl overflow-hidden shadow-2xl border-4 border-gray-700">
                <video id="video" playsinline autoplay class="w-full h-full object-cover"></video>
                <div id="overlay" class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center text-6xl font-bold text-white"></div>
                <div id="flash" class="absolute inset-0 bg-white" style="opacity: 0;"></div>
                 <div id="photo-counter" class="absolute bottom-4 right-4 bg-black bg-opacity-50 text-white text-lg font-semibold px-4 py-2 rounded-lg"></div>
            </div>
        </div>

        <!-- Result Screen -->
        <div id="result-screen" class="hidden text-center">
             <h2 id="result-title" class="text-3xl font-bold mb-2">Here's Your Photo Reel!</h2>
             <p id="result-subtitle" class="text-gray-300 mb-6">Scan the QR code with your phone or use the download button.</p>
            <div class="flex flex-col md:flex-row gap-8 items-center justify-center">
                <div class="w-full md:w-1/2 flex justify-center">
                    <img id="result-image" class="rounded-lg shadow-xl border-4 border-gray-700 max-h-[60vh] w-auto" alt="Your generated photo reel">
                </div>
                <div class="w-full md:w-1/2 flex flex-col items-center gap-6">
                    <div id="qrcode-wrapper" class="p-4 bg-white rounded-lg shadow-lg w-[224px] h-[224px] flex items-center justify-center">
                        <!-- QR code or loader -->
                    </div>
                     <div class="flex flex-col sm:flex-row gap-4 w-full max-w-xs">
                        <a id="download-btn" href="#" download="photobooth-reel.jpg" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition-transform transform hover:scale-105">
                            Download
                        </a>
                        <button id="restart-btn" class="w-full bg-yellow-500 hover:bg-yellow-600 text-red-900 font-bold py-3 px-6 rounded-lg text-lg transition-transform transform hover:scale-105">
                            Start Over
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
     <!-- Viewer Screen (for scanned QR codes) -->
    <div id="viewer-screen" class="hidden text-center p-4">
        <div id="viewer-content">
            <h1 class="text-3xl font-bold mb-4">Your Photo Reel</h1>
            <p id="viewer-status" class="text-lg text-yellow-300 mb-4">Loading your image...</p>
            <img id="viewer-image" class="hidden rounded-lg shadow-xl border-4 border-gray-700 max-w-full max-h-[70vh] mx-auto mb-6" alt="Your photo reel">
            <div id="viewer-controls" class="hidden">
                 <a id="viewer-download-btn" href="#" download="photobooth-reel.jpg" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition-transform transform hover:scale-105 inline-block">
                    Save to Phone
                </a>
                <a href="./index.html" class="mt-4 sm:mt-0 sm:ml-4 bg-yellow-500 hover:bg-yellow-600 text-red-900 font-bold py-3 px-6 rounded-lg text-lg transition-transform transform hover:scale-105 inline-block">
                    Create Your Own
                </a>
            </div>
             <p id="viewer-error" class="text-red-400 mt-4 hidden">Could not find the photo. It may have been deleted or the link is incorrect.</p>
        </div>
    </div>


    <img id="frame-image-preload" src="" class="hidden" alt="Photo booth frame">
    <canvas id="capture-canvas" class="hidden"></canvas>
    <canvas id="reel-canvas" class="hidden"></canvas>

    <script type="module">
        // --- FIREBASE IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- CONFIGURATION ---
        const PHOTO_COUNT = 3;
        const COUNTDOWN_SECONDS = 3;

        // --- DOM ELEMENTS ---
        const appContainer = document.getElementById('app-container');
        const welcomeScreen = document.getElementById('welcome-screen');
        const photoScreen = document.getElementById('photo-screen');
        const resultScreen = document.getElementById('result-screen');
        const startBtn = document.getElementById('start-btn');
        const restartBtn = document.getElementById('restart-btn');
        const downloadBtn = document.getElementById('download-btn');
        const video = document.getElementById('video');
        const overlay = document.getElementById('overlay');
        const flash = document.getElementById('flash');
        const photoCounter = document.getElementById('photo-counter');
        const resultImage = document.getElementById('result-image');
        const qrcodeWrapper = document.getElementById('qrcode-wrapper');
        const cameraError = document.getElementById('camera-error');
        const framePreloadImage = document.getElementById('frame-image-preload');
        const captureCanvas = document.getElementById('capture-canvas');
        const reelCanvas = document.getElementById('reel-canvas');
        const viewerScreen = document.getElementById('viewer-screen');

        // --- FIREBASE & APP STATE ---
        let db, auth, storage;
        let stream;
        let capturedPhotos = [];
        
        // --- PAGE LOAD LOGIC ---
        window.addEventListener('load', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const reelId = urlParams.get('id');

            const firebaseReady = await initializeFirebase();

            if (!firebaseReady) {
                return;
            }

            if (reelId) {
                // VIEWER MODE: Load the reel for viewing and downloading.
                appContainer.classList.add('hidden');
                viewerScreen.classList.remove('hidden');
                loadReelForViewing(reelId);
            } else {
                // PHOTOBOOTH MODE: Initialize the main app UI.
                initializeAppUI();
            }
        });
        
        async function initializeFirebase() {
             try {
                // For Firebase JS SDK v7.20.0 and later, measurementId is optional
                const firebaseConfig = {
                  apiKey: "AIzaSyDLQUtpsWJdanVlmv0tt1gafScAQeN5jj0",
                  authDomain: "photobooth-16410.firebaseapp.com",
                  projectId: "photobooth-16410",
                  storageBucket: "photobooth-16410.firebasestorage.app",
                  messagingSenderId: "436533685722",
                  appId: "1:436533685722:web:1a7c4985825987a66524e3",
                  measurementId: "G-6HGC5VLSDJ"
                };

                if (!firebaseConfig || !firebaseConfig.apiKey || firebaseConfig.apiKey.includes("YOUR")) {
                    console.error("Firebase config is missing or incomplete.");
                    document.body.innerHTML = `<div class="text-center p-8 text-white"><h1>Configuration Error</h1><p>The Firebase configuration is missing. Please add your project's configuration to the script.</p></div>`;
                    return false;
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                storage = getStorage(app);
                
                await signInAnonymously(auth);
                
                console.log("Firebase initialized and user signed in anonymously.");
                return true;
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                 if (error.code === 'auth/configuration-not-found') {
                    document.body.innerHTML = `<div class="text-center p-8 text-white"><h1>Firebase Setup Incomplete</h1><p class="mb-4">The photobooth can't sign in.</p><p class="bg-red-800 p-4 rounded-lg"><strong>Action Required:</strong> Please go to your Firebase project console, navigate to <strong>Authentication -> Sign-in method</strong>, and enable the <strong>Anonymous</strong> provider.</p></div>`;
                } else {
                    document.body.innerHTML = `<div class="text-center p-8 text-white"><h1>Backend Connection Error</h1><p>The application could not connect to its backend services. Please check the Firebase configuration and console for errors.</p><p class="text-sm text-gray-400 mt-2">${error.message}</p></div>`;
                }
                return false;
            }
        }
        
        async function loadReelForViewing(reelId) {
            const viewerStatus = document.getElementById('viewer-status');
            const viewerImage = document.getElementById('viewer-image');
            const viewerControls = document.getElementById('viewer-controls');
            const viewerDownloadBtn = document.getElementById('viewer-download-btn');
            const viewerError = document.getElementById('viewer-error');

            try {
                const docRef = doc(db, "reels", reelId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const reelData = docSnap.data();
                    const imageUrl = reelData.downloadURL;
                    
                    // Set the image source and download link
                    viewerImage.src = imageUrl;
                    viewerDownloadBtn.href = imageUrl;
                    viewerDownloadBtn.download = `vietsoc-reel-${reelId}.jpg`;
                    
                    // Hide loading and show the content
                    viewerStatus.classList.add('hidden');
                    viewerImage.classList.remove('hidden');
                    viewerControls.classList.remove('hidden');

                } else {
                    viewerStatus.classList.add('hidden');
                    viewerError.classList.remove('hidden');
                    console.error("No such document!");
                }
            } catch (error) {
                viewerStatus.classList.add('hidden');
                viewerError.textContent = "An error occurred while fetching the photo.";
                viewerError.classList.remove('hidden');
                console.error("Error getting document:", error);
            }
        }

        // --- PHOTOBOOTH INITIALIZATION ---
        function initializeAppUI() {
            framePreloadImage.src = `assets/frame.png?v=${new Date().getTime()}`;

            startBtn.disabled = true;
            startBtn.classList.add('opacity-50', 'cursor-not-allowed');
            startBtn.textContent = 'Loading Assets...';

            const onAssetsReady = () => {
                startBtn.disabled = false;
                startBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                startBtn.textContent = 'Start Photo Booth';
            };
            
            const onAssetsError = () => {
                 startBtn.textContent = 'Error: Frame Failed to Load';
                 startBtn.classList.add('bg-red-700', 'cursor-not-allowed');
                 console.error("The main frame image could not be loaded. Check that `assets/frame.png` exists.");
            }

            if (framePreloadImage.complete) {
                onAssetsReady();
            } else {
                framePreloadImage.onload = onAssetsReady;
                framePreloadImage.onerror = onAssetsError;
            }
            
            startBtn.addEventListener('click', startPhotoBooth);
            restartBtn.addEventListener('click', restart);
        }
        
        // --- PHOTOBOOTH FUNCTIONS ---
        async function startPhotoBooth() {
            cameraError.classList.add('hidden');
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'user', aspectRatio: 4/3 } 
                });
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    video.play();
                    welcomeScreen.classList.add('hidden');
                    photoScreen.classList.remove('hidden');
                    runPhotoSequence();
                };
            } catch (err) {
                console.error("Camera Error:", err);
                cameraError.classList.remove('hidden');
            }
        }
        
        const delay = ms => new Promise(res => setTimeout(res, ms));

        async function runPhotoSequence() {
            for (let i = 0; i < PHOTO_COUNT; i++) {
                overlay.textContent = `Get Ready...`;
                photoCounter.textContent = `Photo ${i + 1} of ${PHOTO_COUNT}`;
                overlay.classList.remove('hidden');
                await delay(2000);
                for (let j = COUNTDOWN_SECONDS; j > 0; j--) {
                    overlay.textContent = j;
                    await delay(1000);
                }
                overlay.textContent = 'SMILE!';
                await delay(500);
                capturePhoto();
                flash.classList.add('flash-animation');
                setTimeout(() => flash.classList.remove('flash-animation'), 500);
                await delay(1500);
            }
            generateReel();
        }

        function capturePhoto() {
            captureCanvas.width = video.videoWidth;
            captureCanvas.height = video.videoHeight;
            const ctx = captureCanvas.getContext('2d');
            ctx.translate(video.videoWidth, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(video, 0, 0, video.videoWidth, video.videoHeight);
            capturedPhotos.push(captureCanvas.toDataURL('image/jpeg', 0.9));
        }

        function loadImage(src) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = (err) => reject(new Error(`Failed to load image with src: ${src}`));
                img.src = src;
            });
        }

        async function generateReel() {
            photoScreen.classList.add('hidden');
            resultScreen.classList.remove('hidden');
            qrcodeWrapper.innerHTML = `<div class="text-gray-700 text-center">Generating Link...</div>`;

            const ctx = reelCanvas.getContext('2d');
            const reelWidth = 1821;
            const reelHeight = 4096;
            reelCanvas.width = reelWidth;
            reelCanvas.height = reelHeight;
            
             const photoPositions = [
                { x: 140, y: 170,  width: 1541, height: 867 },
                { x: 140, y: 1237, width: 1541, height: 867 },
                { x: 140, y: 2304, width: 1541, height: 867 }
            ];

            try {
                const frame = document.getElementById('frame-image-preload');

                for (let i = 0; i < PHOTO_COUNT; i++) {
                    const img = await loadImage(capturedPhotos[i]);
                    const pos = photoPositions[i];
                    
                    const sourceAspect = img.width / img.height;
                    const destAspect = pos.width / pos.height;
                    
                    let sourceX = 0, sourceY = 0, sourceWidth = img.width, sourceHeight = img.height;

                    if (sourceAspect > destAspect) {
                        sourceWidth = img.height * destAspect;
                        sourceX = (img.width - sourceWidth) / 2;
                    } else {
                        sourceHeight = img.width / destAspect;
                        sourceY = (img.height - sourceHeight) / 2;
                    }
                    ctx.drawImage(img, sourceX, sourceY, sourceWidth, sourceHeight, pos.x, pos.y, pos.width, pos.height);
                }

                ctx.drawImage(frame, 0, 0, reelWidth, reelHeight);

            } catch (error) {
                console.error("Failed to draw reel:", error);
                qrcodeWrapper.innerHTML = `<div class="text-red-600 text-center text-sm">Error creating image.</div>`;
                return;
            }

            const reelDataURL = reelCanvas.toDataURL('image/jpeg', 0.95);
            resultImage.src = reelDataURL;
            downloadBtn.href = reelDataURL;
            
            try {
                 const fileName = `reels/${Date.now()}.jpg`;
                 const storageRef = ref(storage, fileName);
                 const uploadResult = await uploadString(storageRef, reelDataURL, 'data_url');
                 const downloadURL = await getDownloadURL(uploadResult.ref);

                 const docRef = await addDoc(collection(db, "reels"), {
                    downloadURL: downloadURL,
                    createdAt: serverTimestamp()
                });
                
                const viewerURL = `${window.location.href.split('?')[0]}?id=${docRef.id}`;
                
                qrcodeWrapper.innerHTML = '';
                new QRCode(qrcodeWrapper, {
                    text: viewerURL,
                    width: 192,
                    height: 192,
                    colorDark : "#000000",
                    colorLight : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.M
                });

            } catch (e) {
                console.error("Error uploading to Firebase or creating QR Code: ", e);
                qrcodeWrapper.innerHTML = `<div class="text-red-600 text-center text-sm">Could not save image to generate link.</div>`;
            }
        }

        function restart() {
            capturedPhotos = [];
            qrcodeWrapper.innerHTML = '';
            
            if (stream) { stream.getTracks().forEach(track => track.stop()); }

            resultScreen.classList.add('hidden');
            welcomeScreen.classList.remove('hidden');
        }

    </script>
</body>
</html>

